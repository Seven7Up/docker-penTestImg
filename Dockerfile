FROM debian:stable-slim
MAINTAINER Seven7Up

WORKDIR /tmp
SHELL ["/bin/bash","-c"]
ENV DEBIAN_FRONTEND=noninteractive \
    # Change User name and password.
    DOCKER_USER=User \
    DOCKER_PASSWORD=password \
    # Change root password.
    DOCKER_ROOTPASSWORD=rootpassword \
    DOCKER_UID=1000 \
    DOCKER_GID=1000 \
    DOCKER_GROUP=Users \
    # Download new release of webgoat and webwolf from https://github.com/WebGoat/WebGoat/releases if they have
    # Change That if names of files is change.
    WEBGOAT=https://github.com/WebGoat/WebGoat/releases/download/v8.1.0/webgoat-server-8.1.0.jar \
    WEBWOLF=https://github.com/WebGoat/WebGoat/releases/download/v8.1.0/webwolf-8.1.0.jar

RUN apt update -y
RUN apt full-upgrade -y

RUN apt install -y build-essential apt-utils nano sudo dos2unix net-tools curl wget python3 python3-pip git

RUN apt install -y apache2 mariadb-server php php-mysqli php-gd libapache2-mod-php \
    php-mysql php-xml php-mbstring php-curl

RUN groupadd -g $DOCKER_GID $DOCKER_GROUP && \
    useradd -m -u $DOCKER_UID -g $DOCKER_GID -s /bin/bash -G sudo $DOCKER_USER

RUN echo -e "$DOCKER_ROOTPASSWORD\n$DOCKER_ROOTPASSWORD" | passwd && \
    echo -e "$DOCKER_PASSWORD\n$DOCKER_PASSWORD" | passwd $DOCKER_USER

RUN service mysql start && \
    echo -e "\nn\ny\nn\ny\ny" | mysql_secure_installation && \
    mariadb -u root -e "create database dvwa; create user dvwa@localhost identified by 'p@ssw0rd'; grant all on dvwa.* to dvwa@localhost; flush privileges;" && \
    mariadb -u root -e "create database mutillidae; create user mutillidae@localhost identified by 'mutillidae'; grant all on mutillidae.* to mutillidae@localhost; flush privileges;"

RUN git clone https://github.com/webpwnized/mutillidae.git && \
    mv mutillidae /var/www/mutillidae

RUN git clone https://github.com/digininja/DVWA.git dvwa && \
    dos2unix dvwa/setup.php && \
    cp dvwa/config/config.inc.php.dist dvwa/config/config.inc.php && \
    mv dvwa /var/www/dvwa

RUN wget 

COPY MySQLHandler.php /var/www/mutillidae/classes/MySQLHandler.php
COPY 000-default.conf /etc/apache2/sites-available/000-default.conf

RUN apt -y autoremove && \
    rm -rf /var/lib/apt/lists/* /var/tmp/* /var/cache/apt/* /tmp/*

WORKDIR /home/$DOCKER_USER
USER $DOCKER_USER
SHELL ["$DOCKER_SHELL"]